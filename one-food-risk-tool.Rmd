---
title: "One Food risk tool"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "#ffffff"
      fg: "#0c2357" 
      primary: "#006e8c"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(viridis)
library(readxl)
library(here)
library(data.table)
library(DT)
# Install thematic and un-comment for themed static plots (i.e., ggplot2)
# thematic::thematic_rmd()
```

Introduction
================================================================================

Column
--------------------------------------------------------------------------------
#### One Food project

Insert some flavour text about One Food.

#### One Food risk tool

The One Food risk tool maintainer is Sarah Alewijnse (Cefas).
Please email sarah.alewijnse@cefas.gov.uk for debugging assistance.

Data upload {data-navmenu="Risk tool" data-icon="fa-upload"}
================================================================================

Risk visualiser {data-navmenu="Risk tool" data-icon="fa-chart-pie"}
================================================================================

Column {data-width=350 .sidebar}
-----------------------------------------------------------------------


```{r}
# First input selector
  # View by sector or by hazard category
selectInput(inputId = "type",
            label = "Type",
            choices = c("Hazard overview",
                        "Hazard category"))

# Second input selectors -------------------------------------------------------

# Options for hazard category
output$category <- renderUI({
  if(input$type == "Hazard category")
    selectInput(inputId = "category",
                label = "Hazard category",
                choices = c("Biological",
                            "Chemical",
                            "Physical",
                            "Socio-economic"))
})

# Display by sector or impact
output$fill <- renderUI({
  if(input$type %in% c("Hazard overview", "Hazard category")){
    selectInput(inputId = "fill",
                label = "Fill by sector or impact",
                choices = c("Sector",
                            "Impact"))
  }
})

# Render UIs
uiOutput("category")
uiOutput("fill")
```

Column {data-width=650 .tabset}
-----------------------------------------------------------------------

### Plot

```{r}
# Import synthetic data --------------------------------------------------------

# Import
hazard_scores <- read_xlsx(here::here("data",
                                      "data_structure.xlsx")) %>% data.table()

updated_data <- reactive({
  if(input$type == "Hazard category"){
    if(input$fill == "Sector"){
      hazard_scores[Category %in% input$category][, .(Score = sum(Score)), by = c("Sector", "Hazard")]
    } else if(input$fill == "Impact"){
      hazard_scores[Category %in% input$category][, .(Score = sum(Score)), by = c("Impact", "Hazard")]
    }
  } else if(input$type == "Hazard overview"){
    if(input$fill == "Sector"){
      hazard_scores[, .(Score = sum(Score)), by = c("Category", "Sector")]
    } else if(input$fill == "Impact"){
      hazard_scores[, .(Score = sum(Score)), by = c("Category", "Impact")]
    }
  }
})


# Colour palettes --------------------------------------------------------------

## Sector =====

sector_cols <- c("#56B4E9",
                          "#009E73",
                          "#0072B2",
                          "#F0E442")
                          
names(sector_cols) <- c("Aquaculture",
                        "Crops",
                        "Fisheries",
                        "Livestock")

## Hazard category =====

category_cols <- c("#CC6677",
                            "#44AA99",
                            "#6699CC",
                            "#AA4499")

names(category_cols) <- c("Biological",
                            "Chemical",
                            "Physical",
                            "Socio-economic")

## Impact ====

impact_cols <- c("#DDCC77",
                          "#882255",
                          "#117733",
                          "#88CCEE")
                          
names(impact_cols) <- c("Food production",
                        "Human health",
                        "Natural environment",
                        "Climate change")

# Plots
of_plot <- reactive({
  if(input$type == "Hazard category" &&
            input$fill == "Sector"){
    ggplot(data = updated_data()) +
      geom_hline(yintercept = seq(0, 90, 10), colour = "lightgrey") +
      geom_bar(aes(x = str_wrap(Hazard, 5), y = Score, fill = Sector, col = Sector), stat = "identity", alpha = 0.7) +
      coord_polar() +
      scale_fill_manual(values = sector_cols) +
      scale_colour_manual(values = sector_cols) +
      coord_polar() +
      theme_light() +
      theme(axis.text.y = element_blank(),
            axis.ticks = element_blank(),
            axis.title = element_blank(),
            panel.grid = element_blank(),
            legend.position = "bottom",
            text = element_text(size = 20))
  } else if(input$type == "Hazard category" &&
            input$fill == "Impact"){
     ggplot(data = updated_data()) +
      geom_hline(yintercept = seq(0, 90, 10), colour = "lightgrey") +
      geom_bar(aes(x = str_wrap(Hazard, 5), y = Score, fill = Impact, col = Impact), stat = "identity", alpha = 0.7) +
      coord_polar() +
      scale_fill_manual(values = impact_cols) +
      scale_colour_manual(values = impact_cols) +
      coord_polar() +
      theme_light() +
      theme(axis.text.y = element_blank(),
            axis.ticks = element_blank(),
            axis.title = element_blank(),
            panel.grid = element_blank(),
            legend.position = "bottom",
            text = element_text(size = 20))
  } else if(input$type == "Hazard overview" &&
            input$fill == "Sector"){
    ggplot(data = updated_data()) +
      geom_hline(yintercept = seq(0, 400, 100), colour = "lightgrey") +
      geom_bar(aes(x = Category, y = Score, fill = Sector, col = Sector), stat = "identity", alpha = 0.7) +
      coord_polar() +
      scale_fill_manual(values = sector_cols) +
      scale_colour_manual(values = sector_cols) +
      coord_polar() +
      theme_light() +
      ggtitle("Hazard categories by sector") +
      theme(axis.text.y = element_blank(),
            axis.ticks = element_blank(),
            axis.title = element_blank(),
            panel.grid = element_blank(),
            legend.position = "bottom",
            text = element_text(size = 20))
  } else if(input$type == "Hazard overview" &&
            input$fill == "Impact"){
    ggplot(data = updated_data()) +
      geom_hline(yintercept = seq(0, 400, 100), colour = "lightgrey") +
      geom_bar(aes(x = Category, y = Score, fill = Impact, col = Impact), stat = "identity", alpha = 0.7) +
      coord_polar() +
      scale_fill_manual(values = impact_cols) +
      scale_colour_manual(values = impact_cols) +
      coord_polar() +
      theme_light() +
      ggtitle("Hazard categories by impact") +
      theme(axis.text.y = element_blank(),
            axis.ticks = element_blank(),
            axis.title = element_blank(),
            panel.grid = element_blank(),
            legend.position = "bottom",
            text = element_text(size = 20))
  }
})

# Plot
renderPlot({
    of_plot()
})
```

### Data

```{r}
renderDataTable({
  updated_data()
})
```

